<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Toonix TV - Shaka Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.6.0/shaka-player.compiled.min.js"></script>
  <style>
    body {
      margin: 0;
      background: #0f0f23;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }

    .player-wrapper {
      width: 95%;
      max-width: 960px;
      background: #1a1a2e;
      padding: 1rem;
      border-radius: 16px;
      box-shadow: 0 0 40px rgba(78, 205, 196, 0.3);
      position: relative;
    }

    video {
      width: 100%;
      border-radius: 10px;
      background: black;
    }

    .controls {
      margin-top: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
    }

    .controls input[type="text"],
    .controls input[type="file"],
    .controls select,
    .controls button {
      padding: 0.5rem;
      border: none;
      border-radius: 8px;
      font-weight: bold;
    }

    .controls button {
      background: #4ecdc4;
      color: #0f0f23;
      cursor: pointer;
    }

    .controls button:hover {
      background: #38bcb2;
    }

    .three-dot {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 18px;
      cursor: pointer;
    }

    .menu-panel {
      display: none;
      position: absolute;
      top: 45px;
      right: 10px;
      background: rgba(0, 0, 0, 0.85);
      padding: 12px;
      border-radius: 10px;
      flex-direction: column;
      gap: 10px;
      z-index: 100;
    }

    .menu-panel select, .menu-panel button {
      background: #4ecdc4;
      border: none;
      border-radius: 6px;
      padding: 0.4rem;
      color: #0f0f23;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <div class="player-wrapper">
    <video id="video" controls autoplay></video>

    <!-- 3-dot menu -->
    <button class="three-dot" onclick="toggleMenu()">‚ãÆ</button>

    <div class="menu-panel" id="menuPanel">
      <select id="audioSelect"></select>
      <select id="qualitySelect"></select>
      <select id="subSelect"></select>
      <select id="speedSelect">
        <option value="0.5">0.5x</option>
        <option value="1" selected>Normal</option>
        <option value="1.5">1.5x</option>
        <option value="2">2x</option>
      </select>
      <button onclick="togglePip()">üì∫ PiP</button>
      <button onclick="toggleFullscreen()">‚õ∂ Fullscreen</button>
    </div>

    <!-- File + URL input -->
    <div class="controls">
      <input type="file" id="fileInput" accept="video/*" />
      <input type="text" id="urlInput" placeholder="Paste .mpd or video URL..." />
      <button onclick="loadSource()">‚ñ∂Ô∏è Load</button>
    </div>
  </div>

  <script>
    let player = null;
    const video = document.getElementById('video');
    const audioSelect = document.getElementById('audioSelect');
    const qualitySelect = document.getElementById('qualitySelect');
    const subSelect = document.getElementById('subSelect');
    const speedSelect = document.getElementById('speedSelect');

    function toggleMenu() {
      const menu = document.getElementById('menuPanel');
      menu.style.display = (menu.style.display === 'flex') ? 'none' : 'flex';
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        video.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    }

    function togglePip() {
      if (document.pictureInPictureElement) {
        document.exitPictureInPicture();
      } else {
        video.requestPictureInPicture();
      }
    }

    function loadSource() {
      const url = document.getElementById('urlInput').value.trim();
      if (!url) return;
      if (player) player.destroy();
      initPlayer(url);
    }

    function initPlayer(manifestUri) {
      player = new shaka.Player(video);
      player.load(manifestUri).then(() => {
        populateTracks();
        console.log('Video loaded:', manifestUri);
      }).catch(console.error);
    }

    function populateTracks() {
      const audioLangs = player.getAudioLanguages();
      audioSelect.innerHTML = '';
      audioLangs.forEach(lang => {
        const opt = document.createElement('option');
        opt.value = lang;
        opt.textContent = lang;
        audioSelect.appendChild(opt);
      });
      audioSelect.onchange = () => {
        player.selectAudioLanguage(audioSelect.value);
      };

      const tracks = player.getVariantTracks();
      qualitySelect.innerHTML = '';
      tracks.forEach(track => {
        const opt = document.createElement('option');
        opt.value = track.id;
        opt.textContent = `${track.height}p - ${track.bandwidth / 1000} kbps`;
        qualitySelect.appendChild(opt);
      });
      qualitySelect.onchange = () => {
        const id = parseInt(qualitySelect.value);
        const track = tracks.find(t => t.id === id);
        if (track) player.selectVariantTrack(track, true);
      };

      const textTracks = player.getTextTracks();
      subSelect.innerHTML = '<option value="">Off</option>';
      textTracks.forEach(track => {
        const opt = document.createElement('option');
        opt.value = track.language;
        opt.textContent = track.language;
        subSelect.appendChild(opt);
      });
      subSelect.onchange = () => {
        if (subSelect.value) {
          player.setTextTrackVisibility(true);
          player.selectTextLanguage(subSelect.value);
        } else {
          player.setTextTrackVisibility(false);
        }
      };
    }

    speedSelect.onchange = () => {
      video.playbackRate = parseFloat(speedSelect.value);
    };

    document.getElementById("fileInput").addEventListener("change", function () {
      const file = this.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        video.src = url;
        video.load();
        video.play();
      }
    });

    shaka.polyfill.installAll();
    if (!shaka.Player.isBrowserSupported()) {
      alert("Your browser does not support Shaka Player");
    }
  </script>

</body>
</html>
